# 简述 Redis 的哨兵机制

## 为什么会有哨兵？

Redis主从复制模式有致命的缺点：当主节点宕机时，不会自动切换，缺乏了高可用特性。

## 哨兵解决了什么问题？

- 监控，监控每个节点以及哨兵运行状态
- 报警，当发现某个节点或哨兵出现问题，通知其他哨兵
- 自动故障转移，当主节点宕机时，哨兵从原主节点下的所有可用从节点中选举出一个作为主节点，原主节点降为从节点，并将其他从节点的主节点配置改为指定新主节点
- 配置中心，客户端初始化连接的是哨兵节点集合

## 哨兵集群的工作原理

### 一、监控

哨兵周期性的给所有主从Redis节点发送PING命令，检测它们是否仍然在线运行。如果从库没有在规定时间内响应，哨兵就会将其标记为“主观下线”；如果是主库，则会判定主库“主观下线”，当大多数哨兵都判定主库“主观下线”了，主库才会被标记为“客观下线”，进一步走投票选举Leader和自动切换主库流程。

### 二、自动故障转移

#### 主库节点状态标记过程

任一哨兵节点在自身判断主库“主观下线”后，会向其他哨兵节点发出命令用来探测其他哨兵对主库存活的感知状态。当半数以上赞成后，将主库标记为“客观下线”。

#### 哨兵Leader选举

主库被标记为“客观下线”后，哨兵会向其他哨兵节点发出选取命令，当半数以上赞成后，称为哨兵Leader，执行选主和切换操作，并对其他哨兵和客户端进行通知。

#### 筛选

首先会筛选剩余可用的从库，排除掉离线和最近网络状况不好(断连次数)的从库。

#### 打分

进入打分阶段后，会根据优先级、同步进度、ID序列号进行多轮筛选，一旦在某一轮中选出优先级最高的，则直接将其作为主库进行切换。

##### 优先级

手动设置的，slave-priority配置项给不同的库设置不同优先级。优先级从高到低排序打分。

##### 主从同步进度

主库的master_repl_offset记录当前最新的写操作在repl_backlog_buffer的位置，从库的slave_repl_offset记录当前主从同步进度，因此会根据slave_repl_offset最接近master_repl_offset进行打分。

##### ID序列号

每个库实例都会有唯一ID，在优先级和同步进度都相同的情况下，按照ID升序打分。

