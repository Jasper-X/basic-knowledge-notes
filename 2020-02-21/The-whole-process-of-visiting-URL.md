# 在浏览器输入URL到页面展示全过程



### 1. URL文本解析

主要是URL合法性校验。若不合法，则进行错误提示或其他动作，比如现在很多浏览器都已支持在搜索地址栏进行Google搜索。



### . 浏览器本地资源缓存

如果要访问之前访问过的资源，那么会优先判断浏览器本地是否存在缓存，以提升资源加载效率。

大致流程为：

- 是否命中强缓存，如果命中直接使用缓存内容
- 是否命中协商缓存(发送请求到服务器判断，此处会先进行DNS解析)，如果命中直接使用缓存内容

如果没有可用的缓存资源，那么就需要从服务器获取最新的资源。



### 3. DNS解析

在发起网络连接前，首先要获取对方的IP地址，这也是DNS最重要的功能。

通常的查询顺序：浏览器缓存、操作系统缓存、路由器缓存、ISP本地DNS服务器或预设的DNS服务器、根DNS服务器。



### 4. 建立TCP连接

通过DNS解析获取到服务器IP地址后，浏览器将进行系统调用，委托操作系统向服务器发起TCP连接请求。

操作系统会通过TCP三次握手成功(细节不在这里展开)建立一个TCP连接，接着就可以用这个连接来发送HTTP请求报文，或继续建立TLS连接。



### 5. 发送HTTP请求报文

成功建立起一个TCP连接之后，便可以发送HTTP请求报文了。

报文内容主要包括：

- Method。常见的有GET、POST
- Path。即访问的资源路径
- Version。HTTP协议版本号
- Headers。头信息
- Data。携带的数据



### 6. 服务器接收处理请求，并返回HTTP响应报文

服务器的WebServer进程接收到HTTP请求后，一般会交由后方的worker处理，并生成HTTP响应报文返回给客户端。

以PHP-Fpm+Nginx为例，Nginx采用多进程模型，主进程接收请求后由worker进程处理。如请求资源是静态的，则直接将对应文件write到响应报文的Body并返回，否则通过Fast-CGI协议转交PHP-Fpm主进程处理，PHP-Fpm主进程进一步将任务分发给其管理的worker进程，worker进程执行完成后将处理结果即HTTP响应内容返回给Nginx，Nginx再进行处理之后将响应报文返回给客户端。



### 7. 客户端接收处理响应

浏览器接受到由服务器返回的响应内容后，会对内容进行解析，并根据Status Code和Headers做不同的事，比如301/302重定向、gzip解压、资源缓存等等，最终拿到响应报文中的Body进行下一步的页面渲染工作。



### 8. 浏览器页面渲染

如果返回的内容是HTML格式，那么浏览器会其进行自上而下的解析和渲染。

渲染处理工作主要有：

- 按行解析HTML文本，并构建DOM树、CSS规则树、静态资源和脚本资源的加载(脚本资源可能会阻塞页面渲染)
- 编译JavaScript脚本，通常依赖于浏览器内置引擎(如V8)
- DOM树和CSS规则树合并Render树，并通过一系列的计算和级联，确定所有Render树节点的几何属性和样式的权重及层级关系
- 根据Render树进行布局和绘制，最终输出到屏幕









