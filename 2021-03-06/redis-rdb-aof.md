# 简述 Redis 持久化中 rdb 以及 aof 方案的优缺点

Redis的持久化策略有两种：

- RDB：快照式的全量备份，将内存中数据dump到文件中
- AOF：连续的增量备份，把对Redis的服务器进行修改的指令都顺序存储起来

## RDB

#### 工作原理

fork一个子进程处理，子进程可以共享父进程的内存资源，并且不会对内存进行大量copy，而是cow（父进程对数据页进行修改时，会复制一份分离出来，然后对这个复制的页面进行修改，而子进程此时看到的数据还是原来的数据）。

#### 默认配置

```
save 900 1    # 900秒之内，如果超过1个key被修改，则发起快照保存
save 300 10   # 300秒内，如果超过10个key被修改，则发起快照保存
save 60 10000 # 1分钟之内，如果1万个key被修改，则发起快照保存
```

#### 优点

灾备恢复时可以直接将数据全量重放到内存中。

#### 缺点

RDB需要保存整个数据集，所以成本比较高，备份时间也相对长，注定不能频繁操作，一般是定时进行异步备份。如果只使用RDB，发生宕机时可能会丢失最近一段时间的数据。



## AOF

#### 工作原理

存储顺序指令序列，只记录对内存进行修改的指令记录，可以做到全程持久化。当 Redis 重启时，将会读取 AOF 文件进行“重放”以恢复到 Redis 关闭前的最后时刻。

#### 默认配置

```
appendfsync yes        # 开启aof备份
appendfsync always     # 每次有数据修改发生时都会写入AOF文件
appendfsync everysec   # 每秒钟同步一次，该策略为AOF的缺省策略
```

#### 优点

使用AOF会让Redis非常耐久。每秒钟fsync的策略下，Redis可以将性能和数据保障同时兼顾。

#### 缺点

对于相同的数据集，AOF文件体积通常要大于RDB文件体积。并且由于AOF记录的是顺序修改指令，重放数据时也是顺序执行指令进行数据恢复。

AOF文件随着时间的推移会越来越大，需要定期对其进行"瘦身"。AOF瘦身，使用bgrewriteaof命令，原理是开一个子进程对内存遍历，转化为一系列的Redis操作指令，序列化到一个新的AOF文件中，然后将操作期间发生的增量AOF追加到新的AOF日志，追加完毕后立即替代旧的AOF文件。













